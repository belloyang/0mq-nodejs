#include "AsyncTask_HarvestSOH.h"
#include "JSONLogger.h"
#include "ProgressDelegate_Harvest.h"
#include "HarvestParamsParser.h"

#include <Operations/operations.h>

AsyncTask_HarvestSOH::AsyncTask_HarvestSOH(const std::string& libPath,
  const std::string& paramsJSON,
  const uint32_t channelsMask,
  const float updateStep,
  const std::shared_ptr<IHasher>& hasher,
  const std::shared_ptr<ILogger>& logger,
  const std::shared_ptr<IClient>& client)
  : IAsyncTask("harvest_soh", hasher, std::make_shared<JSONLogger>(this, logger))
  , m_libPath(libPath)
  , m_paramsJSON(paramsJSON)
  , m_channelsMask(channelsMask)
  , m_updateStep(updateStep)
  , m_client(client)
  , m_operation(nullptr)
{
  __DEV_CALLSTACK_FUNC__;
}

void AsyncTask_HarvestSOH::_runImpl(const std::shared_ptr<IContext>& context)
{
  __DEV_CALLSTACK_FUNC__;
  // parse harvesting params
  sHarvestParams params;
  if (HarvestParamsParser(m_logger).parse(m_paramsJSON, params))
  {
    // create harvesting operation with progress delegate
    m_operation = std::make_shared<Operation_HarvestSOH>(m_libPath, params, m_channelsMask, m_client,
      std::make_shared<ProgressDelegate_Harvest>(this, context, m_updateStep));
    // execute operation
    m_operation->execute(m_hasher, m_logger);
    // destroy operation
    m_operation = nullptr;
  }
  else
  {
    this->pushCompletionData(eOperationStatus::OP_STATUS_FAILED);
  }
}

bool AsyncTask_HarvestSOH::_stopImpl()
{
  __DEV_CALLSTACK_FUNC__;
  if (m_operation != nullptr)
    return m_operation->stop();
  return false;
}
