#include "Operation_HarvestLogs.h"

#include <PlatformUtils/PlatformUtils.h>

Operation_HarvestLogs::Operation_HarvestLogs(const std::string& libPath,
  const sHarvestParams& params,
  const std::shared_ptr<IClient>& client,
  const std::shared_ptr<IProgressDelegate>& progressDelegate)
: IOperation("harvest-logs")
, m_libPath(libPath)
, m_params(params)
, m_client(client)
, m_progressDelegate(progressDelegate)
{
  __DEV_CALLSTACK_FUNC__;
}

bool Operation_HarvestLogs::_executeImpl(const std::shared_ptr<IHasher>& hasher, 
    const std::shared_ptr<ILogger>& logger)
{
  __DEV_CALLSTACK_FUNC__;
  //tss_harvlib::prepare physical disk/block device for harvesting
  std::string libPath = PlatformUtils::getInstance()->fixDevicePath(m_libPath);
  libPath = PlatformUtils::getInstance()->mapLogicalPathToPhysical(libPath);
  PlatformUtils::getInstance()->unmountAll(libPath);

  // 20181120:
  // A medium I/O buffer size maximises speed when harvesting the forensic log volume.
  std::shared_ptr<PSFLibrary> library(PSFLibrary::create(libPath, hasher, logger, true, __IO_BUFFERS_SIZE_MED__));
  if (library == nullptr || !library->restore())
  {
    logger->error(__THIS_FUNC__, eErrorCategory::ERROR_CATEGORY_LIBRARY, eHarvLibErrorCode::HARVLIB_ERROR_OPERATION_FAILED,
      "'%s' is not a PSF library or doesn't exist. Use 'format' command to create it or 'list' to see all PSF devices available",
      libPath.c_str());
    return false;
  }

  GraphBuilder graphBuilder(logger);
  //tss_harvlib::build chain to harvest logs
  m_headFilter = graphBuilder.buildLogsHaverstingChain(this, library, m_params, 100, 
    m_client, m_progressDelegate);
  if (m_headFilter != nullptr)
  {
    m_headFilter->run(nullptr);
    return true;
  }
  return false;
}

bool Operation_HarvestLogs::_stopImpl()
{
  __DEV_CALLSTACK_FUNC__;
  if (m_headFilter != nullptr)
    m_headFilter->requestStop();
  return true;
}
